<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Product · SVNTeX</title>
    <link rel="stylesheet" href="member.css" />
  </head>
  <body>
    <script>
      (function(){
        var isProd = /(^|\.)svntex\.com$/i.test(location.hostname); var onWww = /^www\./i.test(location.hostname);
        if(isProd && !onWww){ location.replace('https://www.svntex.com/member-v2/product.html'+location.search+location.hash); }
      })();
    </script>
    <div class="member-shell">
      <header class="topbar">
        <div class="brand"><a href="/member-v2/app.html#products" style="text-decoration:none;color:inherit">SVNTeX</a></div>
        <nav>
          <a href="/member-v2/app.html#home">Home</a>
          <a href="/member-v2/app.html#products">Products</a>
          <a href="/member-v2/app.html#wallet">Wallet</a>
          <a href="/member-v2/app.html#referrals">Referrals</a>
          <a href="/member-v2/app.html#profile">Profile</a>
        </nav>
      </header>
      <main class="content">
        <section class="section">
          <div id="pdWrap" class="grid" style="grid-template-columns: 1.2fr 1fr; gap: 16px; align-items: start">
            <div id="pdMedia" class="card" style="min-height:280px;display:flex;align-items:center;justify-content:center">Loading…</div>
            <div id="pdInfo" class="card" style="padding:16px">Loading…</div>
          </div>
        </section>
        <section class="section">
          <h3>Description</h3>
          <div id="pdDesc" class="muted">—</div>
        </section>
      </main>
    </div>
    <script>
    (function(){
      function qs(k){ const u=new URL(location.href); return u.searchParams.get(k); }
      const id = parseInt(qs('id')||'0',10); if(!id){ document.getElementById('pdInfo').textContent='Invalid product'; return; }
      let publicNonce = '';
      async function getPublicNonce(){ try{ const r=await fetch('/wp-json/svntex2/v1/public-nonce'); const j=await r.json(); if(j && j.nonce) return j.nonce; }catch(e){} return ''; }
      function priceFmt(n){ try{ return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(n); }catch(e){ return '₹'+(n||0).toFixed(2); } }
      function imgTag(src){ return src? ('<img src="'+src+'" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:12px">') : '<div class="muted" style="padding:20px">No Image</div>'; }

      async function load(){
        publicNonce = await getPublicNonce();
        const r = await fetch('/wp-json/svntex2/v1/catalog/'+id);
        if(!r.ok){ document.getElementById('pdInfo').textContent='Not found'; return; }
        const p = await r.json();
        // Media
        const media = document.getElementById('pdMedia');
        const imgs = [p.thumbnail_url].concat(p.images||[]).filter(Boolean);
        media.innerHTML = imgs.length ? ('<div style="display:grid;grid-template-columns:1fr;gap:8px;width:100%">'+ imgs.map((src,i)=>'<div class="pimg" style="width:100%;aspect-ratio:4/3;overflow:hidden;background:#0f172a">'+imgTag(src)+'</div>').join('') + '</div>') : imgTag(p.thumbnail_url||'');
        // Info
        const info = document.getElementById('pdInfo');
        const priceLine = (p.min_price===p.max_price)? priceFmt(p.min_price) : (priceFmt(p.min_price)+' – '+priceFmt(p.max_price));
        info.innerHTML = '<h2 style="margin:.25rem 0 0">'+(p.title||'')+'</h2>'+
          '<div class="meta" style="margin:.25rem 0 8px">MRP '+priceFmt(p.mrp||0)+' · Price '+priceLine+'</div>'+
          '<div class="grid" style="grid-template-columns: 120px 100px; gap:8px; align-items: center">'+
            '<label>Qty<input id="qty" type="number" min="1" value="1" style="width:100%"></label>'+
            '<button id="btnAdd">Add to cart</button>'+
          '</div>'+
          '<div id="msg" class="muted" style="margin-top:8px"></div>';
        document.getElementById('btnAdd').addEventListener('click', async ()=>{
          const qty = Math.max(1, parseInt(document.getElementById('qty').value||'1',10));
          const btn = document.getElementById('btnAdd'); const msg = document.getElementById('msg');
          btn.disabled=true; const orig=btn.textContent; btn.textContent='Adding…'; msg.textContent='';
          try{
            const res = await fetch('/wp-json/svntex2/v1/cart/add', { method:'POST', headers:{ 'Content-Type':'application/json','X-SVNTeX2-Nonce': publicNonce }, body: JSON.stringify({ product_id:id, variant_id:0, qty: qty }) });
            const j = await res.json(); if(res.ok && j && j.grand_total!==undefined){ btn.textContent='Added'; msg.textContent='Cart total: '+priceFmt(j.grand_total); }
            else { btn.textContent='Error'; msg.textContent=(j && (j.error||j.message))||'Failed'; }
          }catch(e){ btn.textContent='Error'; msg.textContent='Failed'; }
          setTimeout(()=>{ btn.textContent=orig; btn.disabled=false; }, 1200);
        });
        // Description
        document.getElementById('pdDesc').textContent = p.excerpt || '';
      }
      load();
    })();
    </script>
  </body>
</html>
