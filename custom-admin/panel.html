<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SVNTeX Admin Panel</title>
    <link rel="stylesheet" href="/assets/css/style.css" />
    <style>body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif;padding:20px} .grid{display:grid;gap:14px} table{border-collapse:collapse;width:100%} th,td{border:1px solid #e5e7eb;padding:8px}</style>
  </head>
  <body>
    <div id="layout" style="display:grid;grid-template-columns:260px 1fr;gap:16px;align-items:start">
      <aside id="sidebar" style="border-right:1px solid #e5e7eb;padding-right:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>SVNTeX Admin</strong>
          <button id="btnToggle" aria-label="Toggle menu" title="Toggle menu">☰</button>
        </div>
        <nav style="display:grid;gap:8px;margin-top:12px">
          <a href="#users">Users</a>
          <a href="#products">Products</a>
          <a href="#wallet">Wallet</a>
          <a href="#referrals">Referrals</a>
          <a href="#kyc">KYC</a>
          <a href="#logout" id="logout">Logout</a>
        </nav>
      </aside>
      <main class="grid" style="padding-left:8px">
        <section id="users"><h2>Users</h2>
          <div id="usersBox">Loading...</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
            <div>
              <input id="userSearch" placeholder="Search users (email/username)" style="width:100%" />
              <div id="userList" style="margin-top:8px"></div>
            </div>
            <form id="userForm" class="grid" style="grid-template-columns:1fr;gap:8px">
              <h3>Edit User</h3>
              <input type="hidden" name="id" />
              <label>Customer ID <input name="customer_id" disabled /></label>
              <label>Email <input name="email" required /></label>
              <label>First name <input name="first_name" /></label>
              <label>Last name <input name="last_name" /></label>
              <label>Display name <input name="display_name" /></label>
              <label>Mobile <input name="mobile" /></label>
              <label>Gender <input name="gender" /></label>
              <label>DOB <input name="dob" placeholder="YYYY-MM-DD" /></label>
              <label>Employee ID <input name="employee_id" /></label>
              <label>Referral Source <input name="referral_source" /></label>
              <div><button type="submit">Save Changes</button></div>
              <div id="userMsg" class="muted"></div>
            </form>
          </div>
        </section>
        <section id="products"><h2>Products</h2>
        <form id="prodForm" class="grid" style="grid-template-columns:1fr;max-width:640px">
          <input type="hidden" name="id" />
          <label>Title<input name="title" required placeholder="Product title"></label>
          <label>Vendor ID (optional)<input name="vendor_id" type="number" min="0" placeholder="Vendor ID"></label>
          <label>Description<textarea name="content" rows="4" placeholder="Short description"></textarea></label>
          <div>
            <button type="submit">Save Product</button>
            <button type="button" id="prodReset">New</button>
          </div>
          <div id="prodMsg" class="muted"></div>
        </form>
        <div id="prodList">Loading...</div>
        </section>
      </main>
    </div>
    <script>
    (async function(){
      async function getRestNonce(){
        const r = await fetch('/wp-admin/admin-ajax.php?action=svntex2_get_rest_nonce', { credentials:'include' });
        try { const j = await r.json(); if(j.success) return j.data.nonce; } catch(e){}
        return null;
      }
      const nonce = await getRestNonce();
      const headers = nonce ? { 'X-WP-Nonce': nonce } : {};
      // Basic gate: check logged-in cookie from WP
      const res = await fetch('/wp-json/wp/v2/users/me', { credentials: 'include', headers });
      if(!res.ok){ location.href='/admin/'; return; }
      const me = await res.json();
      // Load users via WP REST (admins only)
      const ures = await fetch('/wp-json/wp/v2/users?per_page=10&orderby=registered&order=desc',{ credentials:'include', headers });
      const users = ures.ok ? await ures.json() : [];
      const box = document.getElementById('usersBox');
      box.innerHTML = users.map(u=>`<div>#${u.id} — ${u.name} (${u.email||'-'})</div>`).join('') || 'No users.';

      // Sidebar collapse
      const layout = document.getElementById('layout');
      document.getElementById('btnToggle').addEventListener('click', ()=>{
        const hidden = layout.style.gridTemplateColumns === '0px 1fr';
        layout.style.gridTemplateColumns = hidden ? '260px 1fr' : '0px 1fr';
      });

      // Users management
      const userList = document.getElementById('userList');
      const userForm = document.getElementById('userForm');
      const userMsg = document.getElementById('userMsg');
      function um(t){ userMsg.textContent=t; }
      async function loadUsers(q=''){
        userList.textContent='Loading...';
        const r = await fetch('/wp-json/svntex2/v1/users?per_page=20&search='+encodeURIComponent(q), { credentials:'include', headers });
        const j = await r.json();
        const items = (j && j.items) || [];
        userList.innerHTML = items.map(u=>`<div><a href="#" data-uid="${u.id}">#${u.id}</a> ${u.username} · ${u.email} · ${u.meta.customer_id||''}</div>`).join('') || 'No users.';
      }
      await loadUsers('');
      document.getElementById('userSearch').addEventListener('input', (e)=>{ loadUsers(e.target.value); });
      userList.addEventListener('click', async (e)=>{
        const id = e.target.getAttribute('data-uid'); if(!id) return; e.preventDefault(); um('');
        const r = await fetch('/wp-json/svntex2/v1/users/'+id, { credentials:'include', headers });
        const u = await r.json();
        userForm.id.value = u.id;
        userForm.customer_id.value = u.meta.customer_id || '';
        userForm.email.value = u.email || '';
        userForm.first_name.value = u.first_name || '';
        userForm.last_name.value = u.last_name || '';
        userForm.display_name.value = u.display_name || '';
        userForm.mobile.value = u.meta.mobile || '';
        userForm.gender.value = u.meta.gender || '';
        userForm.dob.value = u.meta.dob || '';
        userForm.employee_id.value = u.meta.employee_id || '';
        userForm.referral_source.value = u.meta.referral_source || '';
      });
      userForm.addEventListener('submit', async (e)=>{
        e.preventDefault(); um('Saving...');
        const data = Object.fromEntries(new FormData(userForm).entries()); const id = data.id; delete data.id; delete data.customer_id;
        const r = await fetch('/wp-json/svntex2/v1/users/'+id, { method:'POST', credentials:'include', headers:{ ...headers, 'Content-Type':'application/json' }, body: JSON.stringify(data) });
        const j = await r.json(); if(j && j.id){ um('Saved'); } else { um(j.error || 'Save failed'); }
      });

      // Products UI
      const prodList = document.getElementById('prodList');
      const prodForm = document.getElementById('prodForm');
      const prodMsg = document.getElementById('prodMsg');
      function pm(t){ prodMsg.textContent=t; }
      async function loadProducts(){
        pm(''); prodList.textContent = 'Loading...';
        const r = await fetch('/wp-json/svntex2/v1/products', { credentials:'include', headers });
        const j = await r.json();
        const items = (j && j.items) || [];
        prodList.innerHTML = items.map(p=>`<div>
          <strong>#${p.id}</strong> ${p.title} ${p.vendor_id?`· vendor ${p.vendor_id}`:''}
          <a href="#" data-edit="${p.id}">Edit</a>
          <a href="#" data-del="${p.id}">Delete</a>
        </div>`).join('') || 'No products yet.';
      }
      await loadProducts();
      prodList.addEventListener('click', async (e)=>{
        const id = e.target.getAttribute('data-edit');
        if(id){ e.preventDefault();
          const rp = await fetch(`/wp-json/wp/v2/svntex_product/${id}?context=edit`, { credentials:'include', headers });
          if(!rp.ok){ pm('Load failed'); return; }
          const p = await rp.json();
          prodForm.id.value = p.id; prodForm.title.value = (p.title && p.title.raw) || p.title || '';
          prodForm.content.value = (p.content && p.content.raw) || '';
          const v = p.meta && p.meta.vendor_id ? p.meta.vendor_id : '';
          prodForm.vendor_id.value = v;
          pm('Loaded product for editing');
        }
        const delId = e.target.getAttribute('data-del');
        if(delId){ e.preventDefault(); if(!confirm('Delete product #'+delId+'?')) return;
          const r = await fetch(`/wp-json/svntex2/v1/products/${delId}`, { method:'DELETE', credentials:'include', headers });
          const j = await r.json(); if(j.deleted){ pm('Deleted'); loadProducts(); } else { pm(j.error||'Delete failed'); }
        }
      });
      document.getElementById('prodReset').addEventListener('click', (e)=>{ e.preventDefault(); prodForm.reset(); prodForm.id.value=''; pm(''); });
      prodForm.addEventListener('submit', async (e)=>{
        e.preventDefault(); pm('Saving...');
        const data = new FormData(prodForm);
        const id = data.get('id'); data.delete('id');
        const payload = Object.fromEntries(data.entries());
        if(payload.vendor_id) payload.vendor_id = parseInt(payload.vendor_id,10)||0;
        const url = id ? `/wp-json/svntex2/v1/products/${id}` : '/wp-json/svntex2/v1/products';
        const method = 'POST';
        const r = await fetch(url, { method, credentials:'include', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const j = await r.json();
        if(j.id){ pm('Saved'); prodForm.reset(); await loadProducts(); }
        else { pm(j.error || 'Save failed'); }
      });
      document.getElementById('logout').addEventListener('click', async (e)=>{ e.preventDefault(); await fetch('/wp-login.php?action=logout',{credentials:'include'}); location.href='/admin/'; });
    })();
    </script>
  </body>
</html>
