<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SVNTeX Admin v2 Panel</title>
    <link rel="stylesheet" href="admin.css" />
  </head>
  <body>
    <script>
      // Canonical to www and admin-v2 path
      (function(){
        var isProd = /(^|\.)svntex\.com$/i.test(location.hostname);
        var onWww = /^www\./i.test(location.hostname);
        if(isProd && !onWww){ location.replace('https://www.svntex.com/admin-v2/panel.html'+location.hash); }
      })();
    </script>
    <div id="layout" class="admin-shell">
      <aside id="sidebar" class="sidebar">
        <div class="brand"><strong>SVNTeX Admin v2</strong><button id="btnToggle" class="burger" aria-label="Toggle menu" title="Toggle menu">☰</button></div>
        <nav>
          <a href="#dashboard" data-nav class="active">Dashboard</a>
          <a href="#users" data-nav>Users</a>
          <a href="#products" data-nav>Products</a>
          <a href="#orders" data-nav>Orders</a>
          <a href="#wallet" data-nav>Wallet</a>
          <a href="#referrals" data-nav>Referrals</a>
          <a href="#vendors" data-nav>Vendors</a>
          <a href="#support" data-nav>Support</a>
          <a href="#withdrawalsAdmin" data-nav>Withdrawals</a>
          <a href="#kyc" data-nav>KYC</a>
          <a href="#settings" data-nav>Settings</a>
          <a href="#logout" id="logout">Logout</a>
        </nav>
      </aside>
      <main class="content grid">
        <section id="dashboard" class="section">
          <h2>Dashboard</h2>
          <div class="cards" style="margin-top:10px">
            <div class="card" data-goto="#users"><div class="title">Users</div><div class="kpi" id="kpiUsers">--</div><div class="desc">Total registered</div></div>
            <div class="card" data-goto="#products"><div class="title">Products</div><div class="kpi" id="kpiProducts">--</div><div class="desc">Total products</div></div>
            <div class="card" data-goto="#orders"><div class="title">Orders</div><div class="kpi" id="kpiOrders">--</div><div class="desc">Total / Pending</div></div>
            <div class="card" data-goto="#wallet"><div class="title">Wallet</div><div class="kpi" id="kpiWallet">--</div><div class="desc">Tx (7d)</div></div>
            <div class="card"><div class="title">Revenue (Today)</div><div class="kpi" id="kpiRevToday">--</div><div class="desc">Gross</div></div>
            <div class="card"><div class="title">Revenue (Month)</div><div class="kpi" id="kpiRevMonth">--</div><div class="desc">Gross</div></div>
            <div class="card" data-goto="#referrals"><div class="title">Referrals</div><div class="kpi" id="kpiReferrals">--</div><div class="desc">Linked entries</div></div>
            <div class="card" data-goto="#withdrawalsAdmin"><div class="title">Withdrawals</div><div class="kpi" id="kpiWd">--</div><div class="desc">Requested</div></div>
            <div class="card" data-goto="#kyc"><div class="title">KYC</div><div class="kpi" id="kpiKyc">--</div><div class="desc">Pending/Total</div></div>
          </div>
        </section>
        <section id="settings" class="section hidden"><h2>Settings</h2>
          <div class="card" style="max-width:560px">
            <h3>Payments: Razorpay</h3>
            <form id="payForm" class="grid">
              <label>Enabled <select name="enabled"><option value="1">Yes</option><option value="0">No</option></select></label>
              <label>Key ID <input name="key_id" placeholder="rzp_test_xxx" /></label>
              <label>Secret <input name="secret" placeholder="*****" /></label>
              <div><button type="submit">Save</button></div>
              <div id="payMsg" class="muted"></div>
            </form>
          </div>
        </section>
        <section id="orders" class="section hidden"><h2>Orders</h2>
          <div class="grid columns-3" style="max-width:840px">
            <label>Status
              <select id="ordStatus"><option value="">All</option><option>pending</option><option>paid</option><option>processing</option><option>shipped</option><option>delivered</option><option>cancelled</option><option>refunded</option></select>
            </label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="ordLoad">Load</button></div>
          </div>
          <div id="ordList" class="list" style="margin-top:10px">No orders.</div>
        </section>
        <section id="withdrawalsAdmin" class="section hidden"><h2>Withdrawals</h2>
          <div class="grid columns-3" style="max-width:840px">
            <label>Status<select id="wdStatus"><option value="">All</option><option>requested</option><option>approved</option><option>rejected</option></select></label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="wdAdminLoad">Load</button></div>
          </div>
          <div id="wdAdminList" class="list" style="margin-top:10px">No withdrawals.</div>
        </section>
        <section id="users" class="section hidden"><h2>Users</h2>
          <div id="usersBox" class="muted">Loading...</div>
          <div class="grid columns-2" style="margin-top:12px">
            <div>
              <input id="userSearch" placeholder="Search users (email/username)" />
              <div id="userList" class="list" style="margin-top:8px"></div>
            </div>
            <form id="userForm" class="grid">
              <h3>Edit User</h3>
              <input type="hidden" name="id" />
              <label>Customer ID <input name="customer_id" disabled /></label>
              <label>Email <input name="email" required /></label>
              <label>First name <input name="first_name" /></label>
              <label>Last name <input name="last_name" /></label>
              <label>Display name <input name="display_name" /></label>
              <label>Mobile <input name="mobile" /></label>
              <label>Gender <input name="gender" /></label>
              <label>DOB <input name="dob" placeholder="YYYY-MM-DD" /></label>
              <label>Employee ID <input name="employee_id" /></label>
              <label>Referral Source <input name="referral_source" /></label>
              <div><button type="submit">Save Changes</button></div>
              <div id="userMsg" class="muted"></div>
            </form>
          </div>
        </section>
        <section id="products" class="section hidden"><h2>Products</h2>
          <div class="grid columns-3" style="max-width:960px">
            <label>Search
              <input id="prodSearch" placeholder="Search by title, SKU or ID" />
            </label>
            <label>Status
              <select id="prodStatus"><option value="">All</option><option value="publish">Active</option><option value="draft">Draft</option></select>
            </label>
            <label>Stock
              <select id="prodStock"><option value="">Any</option><option value="instock">In stock</option><option value="outofstock">Out of stock</option><option value="onbackorder">On backorder</option></select>
            </label>
          </div>
          <div class="grid" style="grid-auto-flow:column;gap:10px;align-items:end;max-width:960px;margin-top:6px">
            <label>Category<select id="prodCatFilter"><option value="">All</option></select></label>
            <div><button id="prodLoad">Load</button></div>
            <div class="muted">Quick actions: toggle Active/Draft and stock status inline.</div>
          </div>
          <div class="grid" style="grid-auto-flow:column;gap:10px;margin:10px 0">
            <button id="btnNewProduct">Add product</button>
            <label>Per page<select id="prodPer"><option>20</option><option>50</option><option>100</option></select></label>
            <div class="grid" style="grid-auto-flow:column;gap:8px;align-items:center">
              <button id="bulkApply" class="secondary">Bulk apply</button>
              <label><input type="checkbox" id="bulkActive"> Active</label>
              <label><input type="checkbox" id="bulkDraft"> Draft</label>
              <label>Stock<select id="bulkStock"><option value="">—</option><option value="instock">In stock</option><option value="outofstock">Out of stock</option></select></label>
              <label>Price Δ<input id="bulkPriceDelta" type="number" step="0.01" placeholder="+10 / -5"></label>
            </div>
          </div>
          <form id="prodForm" class="grid" style="max-width:640px;display:none">
            <input type="hidden" name="id" />
            <input type="hidden" name="featured_media" />
            <input type="hidden" name="video_media" />
            <label>Title<input name="title" required placeholder="Product title"></label>
            <div class="grid columns-3">
              <label>MRP<input name="mrp" id="pMrp" type="number" step="0.01" min="0" placeholder="0.00"></label>
              <label>Tax %<input name="tax_percent" id="pTax" type="number" step="0.01" min="0" placeholder="0"></label>
              <label>Company Profit<input name="company_profit" id="pProfit" type="number" step="0.01" min="0" placeholder="0.00"></label>
            </div>
            <div class="grid columns-2">
              <label>Base Price<input name="base_price" type="number" step="0.01" min="0" placeholder="0.00"></label>
              <label>Discount Price<input name="discount_price" type="number" step="0.01" min="0" placeholder="0.00"></label>
            </div>
            <div class="grid columns-2">
              <label>SKU<input name="sku" placeholder="SKU"></label>
              <label>Vendor<select name="vendor_id" id="vendorSelect"><option value="">— None —</option></select></label>
            </div>
            <div class="grid columns-3">
              <label>Stock Qty<input name="stock_qty" type="number" min="0" placeholder="0"></label>
              <label>Stock Status
                <select name="stock_status">
                  <option value="">— Select —</option>
                  <option value="instock">In stock</option>
                  <option value="outofstock">Out of stock</option>
                  <option value="onbackorder">On backorder</option>
                </select>
              </label>
              <label>Low Stock Threshold<input name="low_stock_threshold" type="number" min="0" placeholder="0"></label>
            </div>
            <label>Description<textarea name="content" rows="4" placeholder="Short description"></textarea></label>
            <div class="grid columns-2">
              <label>Categories<select name="categories" id="prodCats" multiple size="5"></select></label>
              <div>
                <label>Featured Image
                  <input type="file" id="prodImage" accept="image/png, image/jpeg, image/jpg, image/webp" />
                </label>
                <div id="imgPreview" class="muted" style="margin-top:8px"></div>
              </div>
            </div>
            <div class="grid columns-3">
              <label>Brands<select name="brands" id="brandSelect" multiple size="5"></select></label>
              <label>Tags<select name="tags" id="tagSelect" multiple size="5"></select></label>
              <label>Shipping Class<select name="shipping_class" id="shipClassSelect"></select></label>
            </div>
            <div class="grid columns-2">
              <div>
                <label>Short Video (upload)
                  <input type="file" id="prodVideo" accept="video/*" />
                </label>
                <div id="vidPreview" class="muted" style="margin-top:8px"></div>
              </div>
              <label>Or Video URL<input name="video_url" placeholder="https://..."></label>
            </div>
            <div>
              <label>Gallery Images (upload multiple)
                <input type="file" id="galleryInput" accept="image/png, image/jpeg, image/jpg, image/webp" multiple />
              </label>
              <div id="galleryPreview" class="muted" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;"></div>
            </div>
            <div class="grid columns-4">
              <label>Weight<input name="weight" type="number" step="0.01" min="0" placeholder="0"></label>
              <label>Length<input name="length" type="number" step="0.01" min="0" placeholder="0"></label>
              <label>Width<input name="width" type="number" step="0.01" min="0" placeholder="0"></label>
              <label>Height<input name="height" type="number" step="0.01" min="0" placeholder="0"></label>
            </div>
            <div class="grid columns-2">
              <label>Meta Title<input name="meta_title" placeholder="SEO title"></label>
              <label>Meta Description<textarea name="meta_description" rows="2" placeholder="SEO description"></textarea></label>
            </div>
            <div class="grid columns-2">
              <label>Status
                <select name="status" id="statusSelect">
                  <option value="publish">Publish</option>
                  <option value="draft">Draft</option>
                </select>
              </label>
              <label>Slug<input name="slug" placeholder="custom-slug"></label>
            </div>
            <div class="grid columns-3">
              <label><input type="checkbox" name="is_featured" value="1"> Featured</label>
              <label>Visibility
                <select name="visibility">
                  <option value="public">Public</option>
                  <option value="private">Private</option>
                  <option value="hidden">Hidden</option>
                </select>
              </label>
              <div class="grid" style="grid-auto-flow:column; gap:14px; align-items:center;">
                <label><input type="checkbox" name="approved" value="1"> Approved</label>
                <label><input type="checkbox" name="archived" value="1"> Archived</label>
              </div>
            </div>
            <div class="grid" style="grid-auto-flow:column;justify-content:start"><button type="submit">Save Product</button><button type="button" id="prodReset" class="secondary">Reset</button></div>
            <div id="prodMsg" class="muted"></div>
          </form>
          <div id="prodList" class="list">Loading...</div>
          <div id="prodPager" class="grid" style="grid-auto-flow:column;gap:8px;justify-content:center;margin-top:8px"><button id="prodPrev" class="secondary">Prev</button><span id="prodPageInfo" class="muted"></span><button id="prodNext" class="secondary">Next</button></div>
          <div id="prodReviewsBox" class="grid" style="max-width:860px;margin-top:16px;display:none">
            <div class="grid" style="grid-auto-flow:column;justify-content:start"><button id="prodRevLoad">Load Reviews</button></div>
            <div id="prodRevList" class="list">No reviews.</div>
          </div>
        </section>
        <section id="wallet" class="section hidden"><h2>Wallet</h2>
          <div class="grid columns-3" style="max-width:840px">
            <label>User ID (optional)<input id="wUserId" type="number" min="1" placeholder="Filter by user ID"></label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="wLoad">Load</button></div>
          </div>
          <div id="wList" class="list" style="margin-top:10px">No data.</div>
        </section>
        <section id="referrals" class="section hidden"><h2>Referrals</h2>
          <div class="grid columns-3" style="max-width:840px">
            <label>Referrer ID<input id="refReferrer" type="number" min="1"></label>
            <label>Referee ID<input id="refReferee" type="number" min="1"></label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="refLink">Link</button></div>
          </div>
          <div class="grid columns-3" style="max-width:840px;margin-top:10px">
            <label>Qualify Amount<input id="refAmount" type="number" step="0.01" min="0"></label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="refQualify">Mark Qualified</button></div>
          </div>
          <div class="grid columns-2" style="max-width:840px;margin-top:10px">
            <label>List by Referrer ID<input id="refListReferrer" type="number" min="1"></label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="refLoad">Load</button></div>
          </div>
          <div id="refList" class="list" style="margin-top:10px">No referrals.</div>
        </section>
        <section id="vendors" class="section hidden"><h2>Vendors</h2>
          <div class="grid columns-2" style="max-width:860px">
            <div>
              <div id="venList" class="list">Loading...</div>
            </div>
            <form id="venForm" class="grid">
              <h3>Edit Vendor</h3>
              <input type="hidden" name="id" />
              <label>Name<input name="name" required /></label>
              <label>Email<input name="email" /></label>
              <label>Phone<input name="phone" /></label>
              <label>Notes<textarea name="notes" rows="3"></textarea></label>
              <div class="grid" style="grid-auto-flow:column;justify-content:start"><button type="submit">Save</button><button type="button" id="venNew" class="secondary">New</button></div>
              <div id="venMsg" class="muted"></div>
            </form>
          </div>
        </section>
        <section id="support" class="section hidden"><h2>Support</h2>
          <div class="grid" style="max-width:860px">
            <div class="grid" style="grid-auto-flow:column;justify-content:start"><button id="supLoad">Load Tickets</button><button id="supClear" class="secondary">Clear</button></div>
            <div id="supList" class="list">No tickets.</div>
          </div>
        </section>
        <section id="kyc" class="section hidden"><h2>KYC</h2>
          <div class="grid" style="max-width:860px">
            <div class="grid" style="grid-auto-flow:column;justify-content:start">
              <button id="kycLoad">Load Submissions</button>
            </div>
            <div id="kycList" class="list">No submissions.</div>
          </div>
        </section>
      </main>
    </div>
    <button id="globalMenuBtn" title="Menu" aria-label="Menu" style="position:fixed;left:12px;top:12px;z-index:9999;display:none;background:#0f172a;border:1px solid #23304d;color:#e5e7eb;border-radius:10px;padding:10px 12px;cursor:pointer">☰</button>
    <script>
    (async function(){
      // Safety: if JS loads but router has issues, still navigate via anchors
      Array.from(document.querySelectorAll('a[data-nav]')).forEach(a=>{
        a.addEventListener('click', function(){
          var h=a.getAttribute('href'); if(h&&h.startsWith('#')){ try{ history.replaceState(null,'',h); }catch(e){} }
        });
      });
      // Prime router early so navigation works even if later loads fail/are slow
      const sectionsPrime = Array.from(document.querySelectorAll('main .section'));
      const navLinksPrime = Array.from(document.querySelectorAll('aside nav a'));
      function showPrime(hash){
        if(!hash) hash = '#dashboard';
        sectionsPrime.forEach(s=>{ s.classList.toggle('hidden', '#'+s.id !== hash); });
        navLinksPrime.forEach(a=>{ a.classList.toggle('active', a.getAttribute('href')===hash); });
      }
      window.addEventListener('hashchange', ()=>showPrime(location.hash));
      // Also bind direct click to ensure immediate switch even if hashchange is suppressed
      Array.from(document.querySelectorAll('aside nav a')).forEach(a=>{
        a.addEventListener('click', (e)=>{
          const h = a.getAttribute('href');
          if(h && h.startsWith('#') && h !== '#logout'){
            e.preventDefault(); showPrime(h); if(location.hash !== h){ location.hash = h; }
          }
        });
      });
      showPrime(location.hash||'#dashboard');
      async function getRestNonce(){
        const r = await fetch('/wp-admin/admin-ajax.php?action=svntex2_get_rest_nonce', { credentials:'include' });
        try { const j = await r.json(); if(j.success) return j.data.nonce; } catch(e){}
        return null;
      }
      const nonce = await getRestNonce();
      const headers = nonce ? { 'X-WP-Nonce': nonce } : {};
      const res = await fetch('/wp-json/wp/v2/users/me', { credentials: 'include', headers });
      if(!res.ok){
        alert('Your session has expired. Please sign in again.');
        location.href='/admin-v2/';
        return;
      }
      const me = await res.json();
      // Users pre-load (for KPI and quick list)
      try{
        const ures = await fetch('/wp-json/wp/v2/users?per_page=10&orderby=registered&order=desc',{ credentials:'include', headers });
        const users = ures.ok ? await ures.json() : [];
        const box = document.getElementById('usersBox');
        box.innerHTML = users.map(u=>`<div>#${u.id} — ${u.name} (${u.email||'-'})</div>`).join('') || 'No users.';
      }catch(e){ /* ignore */ }

      // Sidebar + menu button
      const layout = document.getElementById('layout');
      const sidebar = document.getElementById('sidebar');
      const btnLocal = document.getElementById('btnToggle');
      const globalBtn = document.getElementById('globalMenuBtn');
      function applyMenuBtn(){ globalBtn.style.display = window.matchMedia('(max-width:900px)').matches ? 'block' : 'none'; }
      applyMenuBtn();
      window.addEventListener('resize', applyMenuBtn);
      function toggleSidebar(){
        if(window.matchMedia('(max-width:900px)').matches){ sidebar.classList.toggle('open'); }
        else { layout.classList.toggle('collapsed'); }
      }
      btnLocal.addEventListener('click', toggleSidebar);
      globalBtn.addEventListener('click', toggleSidebar);

      function toast(t){ let el=document.querySelector('.toast'); if(!el){ el=document.createElement('div'); el.className='toast'; document.body.appendChild(el); } el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2000); }

      // Users management
      const userList = document.getElementById('userList');
      const userForm = document.getElementById('userForm');
      const userMsg = document.getElementById('userMsg');
      function um(t){ userMsg.textContent=t; }
      async function loadUsers(q=''){
        userList.textContent='Loading...';
        const r = await fetch('/wp-json/svntex2/v1/users?per_page=20&search='+encodeURIComponent(q), { credentials:'include', headers });
        const j = await r.json();
  const items = (j && j.items) || [];
        userList.innerHTML = items.map(u=>`<div><a href="#" data-uid="${u.id}">#${u.id}</a> ${u.username} · ${u.email} · ${u.meta.customer_id||''}</div>`).join('') || 'No users.';
      }
  try{ await loadUsers(''); }catch(e){}
      document.getElementById('userSearch').addEventListener('input', (e)=>{ loadUsers(e.target.value); });
      userList.addEventListener('click', async (e)=>{
        const id = e.target.getAttribute('data-uid'); if(!id) return; e.preventDefault(); um('');
        const r = await fetch('/wp-json/svntex2/v1/users/'+id, { credentials:'include', headers });
        const u = await r.json();
        userForm.id.value = u.id;
        userForm.customer_id.value = u.meta.customer_id || '';
        userForm.email.value = u.email || '';
        userForm.first_name.value = u.first_name || '';
        userForm.last_name.value = u.last_name || '';
        userForm.display_name.value = u.display_name || '';
        userForm.mobile.value = u.meta.mobile || '';
        userForm.gender.value = u.meta.gender || '';
        userForm.dob.value = u.meta.dob || '';
        userForm.employee_id.value = u.meta.employee_id || '';
        userForm.referral_source.value = u.meta.referral_source || '';
      });
      userForm.addEventListener('submit', async (e)=>{
        e.preventDefault(); um('Saving...');
        const data = Object.fromEntries(new FormData(userForm).entries()); const id = data.id; delete data.id; delete data.customer_id;
        const r = await fetch('/wp-json/svntex2/v1/users/'+id, { method:'POST', credentials:'include', headers:{ ...headers, 'Content-Type':'application/json' }, body: JSON.stringify(data) });
        const j = await r.json(); if(j && j.id){ um('Saved'); } else { um(j.error || 'Save failed'); }
      });

      // Products
      const prodList = document.getElementById('prodList');
      const prodForm = document.getElementById('prodForm');
      const prodMsg = document.getElementById('prodMsg');
      function pm(t){ prodMsg.textContent=t; }
      const prodSearch = document.getElementById('prodSearch');
      const prodStatus = document.getElementById('prodStatus');
      const prodStock = document.getElementById('prodStock');
      const prodCatFilter = document.getElementById('prodCatFilter');
      document.getElementById('btnNewProduct')?.addEventListener('click', ()=>{ prodForm.style.display='grid'; window.scrollTo({top: prodForm.offsetTop-60, behavior:'smooth'}); });

      let prodPage = 1; function per(){ const el=document.getElementById('prodPer'); return el?parseInt(el.value,10)||20:20; }
      async function loadProducts(){
        pm(''); prodList.textContent = 'Loading...';
        const qs = new URLSearchParams();
        if(prodSearch?.value){
          const raw = prodSearch.value.trim();
          const idMatch = raw.replace(/^#/,'');
          if(/^\d+$/.test(idMatch)) qs.set('id', idMatch);
          else qs.set('search', raw);
        }
        if(prodStatus?.value){ qs.set('status', prodStatus.value); }
        if(prodStock?.value){ qs.set('stock_status', prodStock.value); }
        if(prodCatFilter?.value){ qs.set('category', prodCatFilter.value); }
        qs.set('per_page', String(per()));
        qs.set('page', String(prodPage));
        const r = await fetch('/wp-json/svntex2/v1/products'+(qs.toString()?('?'+qs.toString()):''), { credentials:'include', headers });
  const j = await r.json(); const items = (j && j.items) || []; const total=j.total||0;
        prodList.innerHTML = items.map(p=>`<div class="list-item"><label style="display:flex;gap:10px;align-items:center"><input type="checkbox" class="sel" value="${p.id}" />${p.thumbnail_url?`<img src="${p.thumbnail_url}" alt="thumb" style="width:48px;height:48px;object-fit:cover;border-radius:6px">`:''}<div><strong>#${p.id}</strong> ${p.title} <div class="meta">SKU ${p.sku||'-'} · ${p.stock_status||'-'} · Qty ${p.stock_qty||0}</div></div></label><div class="grid" style="grid-auto-flow:column;gap:8px;align-items:center"><a href="#" data-edit="${p.id}">Edit</a><a href="#" data-del="${p.id}">Delete</a><a href="#" data-toggle-status="${p.id}" data-st="${p.status==='draft'?'publish':'draft'}">${p.status==='draft'?'Make Active':'Make Draft'}</a><a href="#" data-toggle-stock="${p.id}" data-stock="${p.stock_status==='outofstock'?'instock':'outofstock'}">${p.stock_status==='outofstock'?'Mark In-stock':'Mark Out-of-stock'}</a></div></div>`).join('') || '<div class="muted">No products yet.</div>';
  const pi=document.getElementById('prodPageInfo'); if(pi){ const pages = Math.max(1, Math.ceil(total/ per())); pi.textContent = `Page ${prodPage} / ${pages}`; const prev=document.getElementById('prodPrev'); const next=document.getElementById('prodNext'); if(prev) prev.disabled = (prodPage<=1); if(next) next.disabled = (prodPage>=pages); }
      }
  try{ await loadProducts(); }catch(e){}
      document.getElementById('prodPrev')?.addEventListener('click', (e)=>{ e.preventDefault(); if(prodPage>1){ prodPage--; loadProducts(); } });
      document.getElementById('prodNext')?.addEventListener('click', (e)=>{ e.preventDefault(); prodPage++; loadProducts(); });
      document.getElementById('prodPer')?.addEventListener('change', ()=>{ prodPage=1; loadProducts(); });

      document.getElementById('bulkApply')?.addEventListener('click', async (e)=>{
        e.preventDefault(); const ids = Array.from(prodList.querySelectorAll('input.sel:checked')).map(x=>parseInt(x.value,10)).filter(Boolean); if(!ids.length){ toast('Select items'); return; }
        const updates={}; if(document.getElementById('bulkActive').checked) updates.status='publish'; if(document.getElementById('bulkDraft').checked) updates.status='draft'; const sst=document.getElementById('bulkStock').value; if(sst) updates.stock_status=sst; const d=document.getElementById('bulkPriceDelta').value; if(d){ updates.discount_price_delta=parseFloat(d); }
        // If price delta specified, fetch each item and update price individually
        if(updates.discount_price_delta){
          for(const id of ids){
            const r=await fetch('/wp-json/svntex2/v1/products?id='+id,{credentials:'include',headers}); const j=await r.json(); const p=(j.items||[])[0]; const cur=parseFloat(p.discount_price||p.base_price||0); const next=(cur + updates.discount_price_delta); await fetch('/wp-json/svntex2/v1/products/'+id,{method:'POST',credentials:'include',headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ discount_price: next })});
          }
          toast('Prices updated');
        }
        const simple = { ...updates }; delete simple.discount_price_delta; if(Object.keys(simple).length){ const r=await fetch('/wp-json/svntex2/v1/products/bulk-update',{method:'POST',credentials:'include',headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ ids, updates: simple })}); const j=await r.json(); toast(j.updated?('Updated '+j.updated):'No updates'); }
        loadProducts();
      });
  // Products: list item actions
      prodList.addEventListener('click', async (e)=>{
        const a = e.target.closest('a'); if(!a) return; e.preventDefault();
        const id = parseInt(a.getAttribute('data-edit')||a.getAttribute('data-del')||a.getAttribute('data-toggle-status')||a.getAttribute('data-toggle-stock')||'0',10);
        if(!id) return;
        if(a.hasAttribute('data-del')){
          if(!confirm('Delete product #'+id+'?')) return;
          const r = await fetch('/wp-json/svntex2/v1/products/'+id,{ method:'DELETE', credentials:'include', headers });
          const j = await r.json(); if(j && j.deleted){ toast('Deleted'); loadProducts(); }
          else toast(j.error||'Delete failed');
          return;
        }
        if(a.hasAttribute('data-toggle-status')){
          const st = a.getAttribute('data-st')||'publish';
          await fetch('/wp-json/svntex2/v1/products/'+id,{ method:'POST', credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ status: st }) });
          toast('Status updated'); loadProducts(); return;
        }
        if(a.hasAttribute('data-toggle-stock')){
          const sv = a.getAttribute('data-stock')||'instock';
          await fetch('/wp-json/svntex2/v1/products/'+id,{ method:'POST', credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ stock_status: sv }) });
          toast('Stock updated'); loadProducts(); return;
        }
        if(a.hasAttribute('data-edit')){
          // Load single product and fill form
          const r = await fetch('/wp-json/svntex2/v1/products?id='+id, { credentials:'include', headers });
          const j = await r.json(); const p=(j.items||[])[0]; if(!p){ toast('Not found'); return; }
          fillProductForm(p); prodForm.style.display='grid'; window.scrollTo({top: prodForm.offsetTop-60, behavior:'smooth'});
          return;
        }
      });

      // Load button and filters
      document.getElementById('prodLoad')?.addEventListener('click', ()=>{ prodPage=1; loadProducts(); });
      prodSearch?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); prodPage=1; loadProducts(); }});
      prodStatus?.addEventListener('change', ()=>{ prodPage=1; loadProducts(); });
      prodStock?.addEventListener('change', ()=>{ prodPage=1; loadProducts(); });
      prodCatFilter?.addEventListener('change', ()=>{ prodPage=1; loadProducts(); });

      // Taxonomies and vendors into selects
      async function loadSelects(){
        try{
          const [cats, brands, tags, ships] = await Promise.all([
            fetch('/wp-json/wp/v2/svntex_category?per_page=100',{credentials:'include',headers}),
            fetch('/wp-json/wp/v2/svntex_brand?per_page=100',{credentials:'include',headers}),
            fetch('/wp-json/wp/v2/svntex_tag?per_page=100',{credentials:'include',headers}),
            fetch('/wp-json/wp/v2/svntex_shipping_class?per_page=100',{credentials:'include',headers}),
          ]);
          const [jc, jb, jt, js] = await Promise.all([cats.json(), brands.json(), tags.json(), ships.json()]);
          const catSel = document.getElementById('prodCats'); const catFilter = document.getElementById('prodCatFilter');
          function opt(el, id, name){ const o=document.createElement('option'); o.value=id; o.textContent=name; el.appendChild(o); }
          if(Array.isArray(jc)){
            catSel.innerHTML=''; jc.forEach(t=>opt(catSel, t.id, t.name));
            const keepFirst = catFilter.querySelector('option'); catFilter.innerHTML=''; if(keepFirst) catFilter.appendChild(keepFirst); jc.forEach(t=>opt(catFilter, t.id, t.name));
          }
          const bSel=document.getElementById('brandSelect'); if(Array.isArray(jb)){ bSel.innerHTML=''; jb.forEach(t=>opt(bSel, t.id, t.name)); }
          const tSel=document.getElementById('tagSelect'); if(Array.isArray(jt)){ tSel.innerHTML=''; jt.forEach(t=>opt(tSel, t.id, t.name)); }
          const sSel=document.getElementById('shipClassSelect'); if(Array.isArray(js)){ sSel.innerHTML=''; js.forEach(t=>opt(sSel, t.id, t.name)); }
        }catch(e){ /* ignore */ }
        // Vendors (best-effort, may not exist)
        try{
          const r = await fetch('/wp-json/svntex2/v1/vendors',{credentials:'include',headers}); if(r.ok){ const j=await r.json(); const vs=document.getElementById('vendorSelect'); vs.innerHTML='<option value="">— None —</option>'+ (Array.isArray(j.items)?j.items.map(v=>`<option value="${v.id}">${v.name}</option>`).join(''):'' ); }
        }catch(e){ /* ignore */ }
      }
  try{ await loadSelects(); }catch(e){}

      // Media upload helper
      async function uploadMedia(file){
        const fd = new FormData(); fd.append('file', file); fd.append('status','inherit');
        const r = await fetch('/wp-json/wp/v2/media', { method:'POST', credentials:'include', headers:{ 'X-WP-Nonce': nonce }, body: fd });
        const j = await r.json(); if(j && j.id) return j.id; throw new Error(j.message||'Upload failed');
      }

      // Product form helpers
      function fillProductForm(p){
        prodForm.id.value = p.id || '';
        prodForm.title.value = p.title || '';
        prodForm.slug.value = p.slug || '';
        prodForm.mrp.value = p.mrp || '';
        prodForm.tax_percent.value = p.tax_percent || '';
        prodForm.company_profit.value = p.company_profit || '';
        prodForm.base_price.value = p.base_price || '';
        prodForm.discount_price.value = p.discount_price || '';
        prodForm.sku.value = p.sku || '';
        prodForm.vendor_id.value = p.vendor_id || '';
        prodForm.stock_qty.value = p.stock_qty || '';
        prodForm.stock_status.value = p.stock_status || '';
        prodForm.low_stock_threshold.value = p.low_stock_threshold || '';
        prodForm.content.value = p.content || '';
        document.getElementById('statusSelect').value = p.status || 'publish';
        prodForm.meta_title.value = p.meta_title || '';
        prodForm.meta_description.value = p.meta_description || '';
        prodForm.visibility.value = p.visibility || 'public';
        prodForm.querySelector('input[name="is_featured"]').checked = !!p.is_featured;
        prodForm.querySelector('input[name="approved"]').checked = !!p.approved;
        prodForm.querySelector('input[name="archived"]').checked = !!p.archived;
        // Multi-selects
        function setMulti(sel, ids){ const set=new Set((ids||[]).map(String)); Array.from(sel.options).forEach(o=>{ o.selected = set.has(String(o.value)); }); }
        setMulti(document.getElementById('prodCats'), p.categories);
        setMulti(document.getElementById('brandSelect'), p.brands);
        setMulti(document.getElementById('tagSelect'), p.tags);
        const shipSel=document.getElementById('shipClassSelect'); if(p.shipping_class && p.shipping_class.length){ shipSel.value = String(p.shipping_class[0]); }
        // Media hidden IDs
        prodForm.featured_media.value = p.featured_media||'';
        prodForm.video_media.value = p.video_media||'';
        document.getElementById('imgPreview').textContent = p.thumbnail_url?('Current image set'):'';
        document.getElementById('vidPreview').textContent = p.video_url?('Video URL set'):'';
      }

      document.getElementById('prodReset')?.addEventListener('click', ()=>{ prodForm.reset(); prodForm.style.display='none'; document.getElementById('imgPreview').textContent=''; document.getElementById('vidPreview').textContent=''; document.getElementById('galleryPreview').innerHTML=''; pm(''); });

      // Image/video previews and uploads
      document.getElementById('prodImage')?.addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; document.getElementById('imgPreview').textContent='Uploading...'; try{ const id=await uploadMedia(f); prodForm.featured_media.value=id; document.getElementById('imgPreview').textContent='Image uploaded'; }catch(err){ document.getElementById('imgPreview').textContent='Upload failed'; }});
      document.getElementById('prodVideo')?.addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; document.getElementById('vidPreview').textContent='Uploading...'; try{ const id=await uploadMedia(f); prodForm.video_media.value=id; document.getElementById('vidPreview').textContent='Video uploaded'; }catch(err){ document.getElementById('vidPreview').textContent='Upload failed'; }});
      document.getElementById('galleryInput')?.addEventListener('change', async (e)=>{ const files=Array.from(e.target.files||[]); const box=document.getElementById('galleryPreview'); box.textContent='Uploading '+files.length+' images...'; const ids=[]; for(const f of files){ try{ const id=await uploadMedia(f); ids.push(id); }catch(err){} } box.textContent = ids.length?('Added '+ids.length+' images'):'No images added'; prodForm.querySelector('input[name="gallery"]')?.remove(); const hidden=document.createElement('input'); hidden.type='hidden'; hidden.name='gallery'; hidden.value = ids.join(','); prodForm.appendChild(hidden); });

      // Submit product create/update
      prodForm.addEventListener('submit', async (e)=>{
        e.preventDefault(); pm('Saving...');
        const data = Object.fromEntries(new FormData(prodForm).entries());
        // Normalize multi-selects
        function vals(sel){ return Array.from(sel.selectedOptions).map(o=>parseInt(o.value,10)).filter(Boolean); }
        data.categories = vals(document.getElementById('prodCats'));
        data.brands = vals(document.getElementById('brandSelect'));
        data.tags = vals(document.getElementById('tagSelect'));
        const sc = document.getElementById('shipClassSelect'); data.shipping_class = sc && sc.value? [parseInt(sc.value,10)] : [];
        data.is_featured = prodForm.querySelector('input[name="is_featured"]').checked ? 1 : 0;
        data.archived = prodForm.querySelector('input[name="archived"]').checked ? 1 : 0;
        data.approved = prodForm.querySelector('input[name="approved"]').checked ? 1 : 0;
  // Gallery CSV -> array of ints
  if (data.gallery) { data.gallery = String(data.gallery).split(',').map(s=>parseInt(s,10)).filter(Boolean); }
        // Numeric coercion
        ['mrp','tax_percent','company_profit','base_price','discount_price','stock_qty','low_stock_threshold','weight','length','width','height','vendor_id'].forEach(k=>{ if(data[k]!==undefined && data[k]!=='' ) data[k] = Number(data[k]); });
        const id = data.id; delete data.id;
        const url = id? ('/wp-json/svntex2/v1/products/'+id) : '/wp-json/svntex2/v1/products';
        const method = id? 'POST' : 'POST';
        const r = await fetch(url, { method, credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify(data) });
        const j = await r.json(); if(j && (j.id || j.ok)) { pm('Saved'); toast('Saved'); prodForm.style.display='none'; loadProducts(); }
        else { pm(j.error||'Save failed'); }
      });

      // Simple hash router for sections
      const sections = Array.from(document.querySelectorAll('main .section'));
      const navLinks = Array.from(document.querySelectorAll('aside nav a'));
      function show(hash){
        if(!hash) hash = '#dashboard';
        sections.forEach(s=>{ s.classList.toggle('hidden', '#'+s.id !== hash); });
        navLinks.forEach(a=>{ a.classList.toggle('active', a.getAttribute('href')===hash); });
        if(hash==='#dashboard'){ loadKpis(); }
      }
      window.addEventListener('hashchange', ()=>show(location.hash));
      show(location.hash||'#dashboard');

      // KPIs
      async function loadKpis(){
        try{
          const r = await fetch('/wp-json/svntex2/v1/admin/analytics', { credentials:'include', headers });
          const j = await r.json();
          if(!j) return;
          const $ = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent = (typeof v==='number')? String(v) : (v||'--'); };
          $('kpiUsers', j.users_total);
          $('kpiProducts', j.products_total);
          $('kpiOrders', `${j.orders_total} / ${j.orders_pending}`);
          $('kpiWallet', `${j.wallet_7d_count} (${(j.wallet_7d_sum||0).toFixed(2)})`);
          $('kpiRevToday', (j.revenue_today||0).toFixed(2));
          $('kpiRevMonth', (j.revenue_month||0).toFixed(2));
          $('kpiReferrals', '--');
          $('kpiWd', j.withdrawals_requested);
          $('kpiKyc', '--');
        }catch(e){}
      }

      // Orders list
      document.getElementById('ordLoad')?.addEventListener('click', async ()=>{
        const st = document.getElementById('ordStatus').value; const qs = st? ('?status='+encodeURIComponent(st)) : '';
        const r = await fetch('/wp-json/svntex2/v1/admin/orders'+qs, { credentials:'include', headers }); const j=await r.json(); const box=document.getElementById('ordList');
        const items = (j && j.items)||[]; box.innerHTML = items.length? items.map(o=>`<div class="list-item">#${o.id} · User ${o.user_id} · ${o.status} · Total ₹${o.grand_total?.toFixed?o.grand_total.toFixed(2):o.grand_total} <button data-oid="${o.id}" data-st="processing" class="btnSmall">Mark Processing</button> <button data-oid="${o.id}" data-st="shipped" class="btnSmall">Mark Shipped</button></div>`).join('') : 'No orders.';
        box.querySelectorAll('button[data-oid]')?.forEach(btn=>btn.addEventListener('click', async (e)=>{ const b=e.currentTarget; const id=b.getAttribute('data-oid'); const st=b.getAttribute('data-st'); await fetch('/wp-json/svntex2/v1/admin/orders/'+id,{method:'POST',credentials:'include',headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ status: st })}); toast('Updated'); }));
      });

      // Withdrawals list
      document.getElementById('wdAdminLoad')?.addEventListener('click', async ()=>{
        const st=document.getElementById('wdStatus').value; const qs=st?('?status='+encodeURIComponent(st)) : '';
        const r=await fetch('/wp-json/svntex2/v1/admin/withdrawals'+qs,{credentials:'include',headers}); const j=await r.json(); const box=document.getElementById('wdAdminList');
        const items=(j&&j.items)||[]; box.innerHTML = items.length? items.map(w=>`<div class="list-item">#${w.id} · User ${w.user_id} · ${w.status} · ₹${w.amount?.toFixed?w.amount.toFixed(2):w.amount} <button data-wid="${w.id}" data-act="approve" class="btnSmall">Approve</button> <button data-wid="${w.id}" data-act="reject" class="btnSmall">Reject</button></div>`).join('') : 'No withdrawals.';
        box.querySelectorAll('button[data-wid]')?.forEach(btn=>btn.addEventListener('click', async (e)=>{ const b=e.currentTarget; const id=b.getAttribute('data-wid'); const act=b.getAttribute('data-act'); await fetch('/wp-json/svntex2/v1/admin/withdrawals/'+id,{method:'POST',credentials:'include',headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ action: act })}); toast('Updated'); }));
      });

      // Wallet transactions (admin view)
      document.getElementById('wLoad')?.addEventListener('click', async ()=>{
        const uid = parseInt(document.getElementById('wUserId').value||'0',10); const qs = uid? ('?user_id='+uid) : '';
        const r = await fetch('/wp-json/svntex2/v1/wallet/transactions'+qs, { credentials:'include', headers }); const j = await r.json(); const box=document.getElementById('wList');
        const items=(j&&j.items)||[]; box.innerHTML = items.length? items.map(t=>`<div class="list-item">#${t.id} · U${t.user_id} · ${t.category} · ${(t.amount>0?'+':'')}${t.amount} · ${t.created_at}</div>`).join('') : 'No data.';
      });

      // Referrals
      document.getElementById('refLink')?.addEventListener('click', async ()=>{
        const ref = parseInt(document.getElementById('refReferrer').value||'0',10); const ree = parseInt(document.getElementById('refReferee').value||'0',10); if(!ref||!ree){ toast('IDs required'); return; }
        const r=await fetch('/wp-json/svntex2/v1/referrals/link',{method:'POST',credentials:'include',headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ referrer_id:ref, referee_id:ree })}); const j=await r.json(); toast(j.ok?'Linked':'Failed');
      });
      document.getElementById('refQualify')?.addEventListener('click', async ()=>{
        const ref = parseInt(document.getElementById('refReferrer').value||'0',10); const ree = parseInt(document.getElementById('refReferee').value||'0',10); const amt = parseFloat(document.getElementById('refAmount').value||'0'); if(!ref||!ree){ toast('IDs required'); return; }
        const r=await fetch('/wp-json/svntex2/v1/referrals/qualify',{method:'POST',credentials:'include',headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ referrer_id:ref, referee_id:ree, amount: amt })}); const j=await r.json(); toast(j.ok?'Marked':'Failed');
      });
      document.getElementById('refLoad')?.addEventListener('click', async ()=>{
        const rid = parseInt(document.getElementById('refListReferrer').value||'0',10); const qs = rid? ('?referrer_id='+rid) : '';
        const r=await fetch('/wp-json/svntex2/v1/referrals'+qs,{credentials:'include',headers}); const j=await r.json(); const box=document.getElementById('refList'); const items=(j&&j.items)||[]; box.innerHTML = items.length? items.map(x=>`<div class="list-item">Referrer ${x.referrer_id||'?'} → Referee ${x.referee_id||'?'} · ${x.qualified?'Qualified':'—'}</div>`).join('') : 'No referrals.';
      });

      // Support
  var supLoad=document.getElementById('supLoad'); if(supLoad){ supLoad.addEventListener('click', async ()=>{ const r=await fetch('/wp-json/svntex2/v1/admin/support',{credentials:'include',headers}); const j=await r.json(); const box=document.getElementById('supList'); const items=(j&&j.items)||[]; box.innerHTML = items.length? items.map(t=>`<div class="list-item">U${t.user_id}: <strong>${t.subject}</strong><br>${t.message}<div class="muted">${t.ts}</div></div>`).join('') : 'No tickets.'; }); }
  var supClear=document.getElementById('supClear'); if(supClear){ supClear.addEventListener('click', async ()=>{ if(!confirm('Clear all tickets?')) return; await fetch('/wp-json/svntex2/v1/admin/support/clear',{method:'POST',credentials:'include',headers}); toast('Cleared'); document.getElementById('supList').textContent='No tickets.'; }); }

      // KYC
      document.getElementById('kycLoad')?.addEventListener('click', async ()=>{ const r=await fetch('/wp-json/svntex2/v1/kyc',{credentials:'include',headers}); const j=await r.json(); const box=document.getElementById('kycList'); const items=(j&&j.items)||[]; box.innerHTML = items.length? items.map(k=>`<div class="list-item">#${k.id} · U${k.user_id} · ${k.status} · ${k.created_at||''}</div>`).join('') : 'No submissions.'; });

      // Logout
  var logoutEl=document.getElementById('logout'); if(logoutEl){ logoutEl.addEventListener('click', (e)=>{ e.preventDefault(); location.href = '/wp-admin/admin-post.php?action=svntex2_logout'; }); }

      // Settings: Payments
      const payForm = document.getElementById('payForm');
      const payMsg = document.getElementById('payMsg');
      async function loadPay(){
        try{
          const r = await fetch('/wp-json/svntex2/v1/admin/payments/config', { credentials:'include', headers });
          if(!r.ok) return; const j = await r.json(); const rz=(j && j.razorpay)||{};
          payForm.enabled.value = (rz.enabled? '1':'0');
          payForm.key_id.value = rz.key_id || '';
        }catch(e){}
      }
  await loadPay();
  payForm.addEventListener('submit', async (e)=>{
        e.preventDefault(); payMsg.textContent='Saving...';
        const data = Object.fromEntries(new FormData(payForm).entries());
        const body = { enabled: data.enabled==='1', razorpay: { key_id: data.key_id, secret: data.secret||undefined } };
        const r = await fetch('/wp-json/svntex2/v1/admin/payments/config', { method:'POST', credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const j = await r.json(); payMsg.textContent = (r.ok && j && j.ok)? 'Saved' : ((j && (j.error||j.message))||'Failed');
      });
    </script>
  </body>
</html>
