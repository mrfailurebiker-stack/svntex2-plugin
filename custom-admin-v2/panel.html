<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SVNTeX Admin v2 Panel</title>
    <link rel="stylesheet" href="admin.css" />
  </head>
  <body>
    <script>
      // Canonical to www and admin-v2 path
      (function(){
        var isProd = /(^|\.)svntex\.com$/i.test(location.hostname);
        var onWww = /^www\./i.test(location.hostname);
        if(isProd && !onWww){ location.replace('https://www.svntex.com/admin-v2/panel.html'+location.hash); }
      })();
    </script>
    <div id="layout" class="admin-shell">
      <aside id="sidebar" class="sidebar">
        <div class="brand"><strong>SVNTeX Admin v2</strong><button id="btnToggle" class="burger" aria-label="Toggle menu" title="Toggle menu">☰</button></div>
        <nav>
          <a href="#dashboard" class="active">Dashboard</a>
          <a href="#users">Users</a>
          <a href="#products">Products</a>
          <a href="#orders">Orders</a>
          <a href="#wallet">Wallet</a>
          <a href="#referrals">Referrals</a>
          <a href="#vendors">Vendors</a>
          <a href="#support">Support</a>
          <a href="#withdrawalsAdmin">Withdrawals</a>
          <a href="#kyc">KYC</a>
          <a href="#logout" id="logout">Logout</a>
        </nav>
      </aside>
      <main class="content grid">
        <section id="dashboard" class="section">
          <h2>Dashboard</h2>
          <div class="cards" style="margin-top:10px">
            <div class="card" data-goto="#users"><div class="title">Users</div><div class="kpi" id="kpiUsers">--</div><div class="desc">Total registered</div></div>
            <div class="card" data-goto="#products"><div class="title">Products</div><div class="kpi" id="kpiProducts">--</div><div class="desc">Total products</div></div>
            <div class="card" data-goto="#orders"><div class="title">Orders</div><div class="kpi" id="kpiOrders">--</div><div class="desc">Total / Pending</div></div>
            <div class="card" data-goto="#wallet"><div class="title">Wallet</div><div class="kpi" id="kpiWallet">--</div><div class="desc">Tx (7d)</div></div>
            <div class="card"><div class="title">Revenue (Today)</div><div class="kpi" id="kpiRevToday">--</div><div class="desc">Gross</div></div>
            <div class="card"><div class="title">Revenue (Month)</div><div class="kpi" id="kpiRevMonth">--</div><div class="desc">Gross</div></div>
            <div class="card" data-goto="#referrals"><div class="title">Referrals</div><div class="kpi" id="kpiReferrals">--</div><div class="desc">Linked entries</div></div>
            <div class="card" data-goto="#withdrawalsAdmin"><div class="title">Withdrawals</div><div class="kpi" id="kpiWd">--</div><div class="desc">Requested</div></div>
            <div class="card" data-goto="#kyc"><div class="title">KYC</div><div class="kpi" id="kpiKyc">--</div><div class="desc">Pending/Total</div></div>
          </div>
        </section>
        <section id="orders" class="section hidden"><h2>Orders</h2>
          <div class="grid columns-3" style="max-width:840px">
            <label>Status
              <select id="ordStatus"><option value="">All</option><option>pending</option><option>paid</option><option>processing</option><option>shipped</option><option>delivered</option><option>cancelled</option><option>refunded</option></select>
            </label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="ordLoad">Load</button></div>
          </div>
          <div id="ordList" class="list" style="margin-top:10px">No orders.</div>
        </section>
        <section id="withdrawalsAdmin" class="section hidden"><h2>Withdrawals</h2>
          <div class="grid columns-3" style="max-width:840px">
            <label>Status<select id="wdStatus"><option value="">All</option><option>requested</option><option>approved</option><option>rejected</option></select></label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="wdAdminLoad">Load</button></div>
          </div>
          <div id="wdAdminList" class="list" style="margin-top:10px">No withdrawals.</div>
        </section>
        <section id="users" class="section hidden"><h2>Users</h2>
          <div id="usersBox" class="muted">Loading...</div>
          <div class="grid columns-2" style="margin-top:12px">
            <div>
              <input id="userSearch" placeholder="Search users (email/username)" />
              <div id="userList" class="list" style="margin-top:8px"></div>
            </div>
            <form id="userForm" class="grid">
              <h3>Edit User</h3>
              <input type="hidden" name="id" />
              <label>Customer ID <input name="customer_id" disabled /></label>
              <label>Email <input name="email" required /></label>
              <label>First name <input name="first_name" /></label>
              <label>Last name <input name="last_name" /></label>
              <label>Display name <input name="display_name" /></label>
              <label>Mobile <input name="mobile" /></label>
              <label>Gender <input name="gender" /></label>
              <label>DOB <input name="dob" placeholder="YYYY-MM-DD" /></label>
              <label>Employee ID <input name="employee_id" /></label>
              <label>Referral Source <input name="referral_source" /></label>
              <div><button type="submit">Save Changes</button></div>
              <div id="userMsg" class="muted"></div>
            </form>
          </div>
        </section>
        <section id="products" class="section hidden"><h2>Products</h2>
          <div class="grid columns-3" style="max-width:960px">
            <label>Search
              <input id="prodSearch" placeholder="Search by title, SKU or ID" />
            </label>
            <label>Status
              <select id="prodStatus"><option value="">All</option><option value="publish">Active</option><option value="draft">Draft</option></select>
            </label>
            <label>Stock
              <select id="prodStock"><option value="">Any</option><option value="instock">In stock</option><option value="outofstock">Out of stock</option><option value="onbackorder">On backorder</option></select>
            </label>
          </div>
          <div class="grid" style="grid-auto-flow:column;gap:10px;align-items:end;max-width:960px;margin-top:6px">
            <label>Category<select id="prodCatFilter"><option value="">All</option></select></label>
            <div><button id="prodLoad">Load</button></div>
            <div class="muted">Quick actions: toggle Active/Draft and stock status inline.</div>
          </div>
          <div class="grid" style="grid-auto-flow:column;gap:10px;margin:10px 0"><button id="btnNewProduct">Add product</button></div>
          <form id="prodForm" class="grid" style="max-width:640px;display:none">
            <input type="hidden" name="id" />
            <input type="hidden" name="featured_media" />
            <input type="hidden" name="video_media" />
            <label>Title<input name="title" required placeholder="Product title"></label>
            <div class="grid columns-3">
              <label>MRP<input name="mrp" id="pMrp" type="number" step="0.01" min="0" placeholder="0.00"></label>
              <label>Tax %<input name="tax_percent" id="pTax" type="number" step="0.01" min="0" placeholder="0"></label>
              <label>Company Profit<input name="company_profit" id="pProfit" type="number" step="0.01" min="0" placeholder="0.00"></label>
            </div>
            <div class="grid columns-2">
              <label>Base Price<input name="base_price" type="number" step="0.01" min="0" placeholder="0.00"></label>
              <label>Discount Price<input name="discount_price" type="number" step="0.01" min="0" placeholder="0.00"></label>
            </div>
            <div class="grid columns-2">
              <label>SKU<input name="sku" placeholder="SKU"></label>
              <label>Vendor<select name="vendor_id" id="vendorSelect"><option value="">— None —</option></select></label>
            </div>
            <div class="grid columns-3">
              <label>Stock Qty<input name="stock_qty" type="number" min="0" placeholder="0"></label>
              <label>Stock Status
                <select name="stock_status">
                  <option value="">— Select —</option>
                  <option value="instock">In stock</option>
                  <option value="outofstock">Out of stock</option>
                  <option value="onbackorder">On backorder</option>
                </select>
              </label>
              <label>Low Stock Threshold<input name="low_stock_threshold" type="number" min="0" placeholder="0"></label>
            </div>
            <label>Description<textarea name="content" rows="4" placeholder="Short description"></textarea></label>
            <div class="grid columns-2">
              <label>Categories<select name="categories" id="prodCats" multiple size="5"></select></label>
              <div>
                <label>Featured Image
                  <input type="file" id="prodImage" accept="image/png, image/jpeg, image/jpg, image/webp" />
                </label>
                <div id="imgPreview" class="muted" style="margin-top:8px"></div>
              </div>
            </div>
            <div class="grid columns-3">
              <label>Brands<select name="brands" id="brandSelect" multiple size="5"></select></label>
              <label>Tags<select name="tags" id="tagSelect" multiple size="5"></select></label>
              <label>Shipping Class<select name="shipping_class" id="shipClassSelect"></select></label>
            </div>
            <div class="grid columns-2">
              <div>
                <label>Short Video (upload)
                  <input type="file" id="prodVideo" accept="video/*" />
                </label>
                <div id="vidPreview" class="muted" style="margin-top:8px"></div>
              </div>
              <label>Or Video URL<input name="video_url" placeholder="https://..."></label>
            </div>
            <div>
              <label>Gallery Images (upload multiple)
                <input type="file" id="galleryInput" accept="image/png, image/jpeg, image/jpg, image/webp" multiple />
              </label>
              <div id="galleryPreview" class="muted" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;"></div>
            </div>
            <div class="grid columns-4">
              <label>Weight<input name="weight" type="number" step="0.01" min="0" placeholder="0"></label>
              <label>Length<input name="length" type="number" step="0.01" min="0" placeholder="0"></label>
              <label>Width<input name="width" type="number" step="0.01" min="0" placeholder="0"></label>
              <label>Height<input name="height" type="number" step="0.01" min="0" placeholder="0"></label>
            </div>
            <div class="grid columns-2">
              <label>Meta Title<input name="meta_title" placeholder="SEO title"></label>
              <label>Meta Description<textarea name="meta_description" rows="2" placeholder="SEO description"></textarea></label>
            </div>
            <div class="grid columns-2">
              <label>Status
                <select name="status" id="statusSelect">
                  <option value="publish">Publish</option>
                  <option value="draft">Draft</option>
                </select>
              </label>
              <label>Slug<input name="slug" placeholder="custom-slug"></label>
            </div>
            <div class="grid columns-3">
              <label><input type="checkbox" name="is_featured" value="1"> Featured</label>
              <label>Visibility
                <select name="visibility">
                  <option value="public">Public</option>
                  <option value="private">Private</option>
                  <option value="hidden">Hidden</option>
                </select>
              </label>
              <div class="grid" style="grid-auto-flow:column; gap:14px; align-items:center;">
                <label><input type="checkbox" name="approved" value="1"> Approved</label>
                <label><input type="checkbox" name="archived" value="1"> Archived</label>
              </div>
            </div>
            <div class="grid" style="grid-auto-flow:column;justify-content:start"><button type="submit">Save Product</button><button type="button" id="prodReset" class="secondary">Reset</button></div>
            <div id="prodMsg" class="muted"></div>
          </form>
          <div id="prodList" class="list">Loading...</div>
          <div id="prodReviewsBox" class="grid" style="max-width:860px;margin-top:16px;display:none">
            <div class="grid" style="grid-auto-flow:column;justify-content:start"><button id="prodRevLoad">Load Reviews</button></div>
            <div id="prodRevList" class="list">No reviews.</div>
          </div>
        </section>
        <section id="wallet" class="section hidden"><h2>Wallet</h2>
          <div class="grid columns-3" style="max-width:840px">
            <label>User ID (optional)<input id="wUserId" type="number" min="1" placeholder="Filter by user ID"></label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="wLoad">Load</button></div>
          </div>
          <div id="wList" class="list" style="margin-top:10px">No data.</div>
        </section>
        <section id="referrals" class="section hidden"><h2>Referrals</h2>
          <div class="grid columns-3" style="max-width:840px">
            <label>Referrer ID<input id="refReferrer" type="number" min="1"></label>
            <label>Referee ID<input id="refReferee" type="number" min="1"></label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="refLink">Link</button></div>
          </div>
          <div class="grid columns-3" style="max-width:840px;margin-top:10px">
            <label>Qualify Amount<input id="refAmount" type="number" step="0.01" min="0"></label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="refQualify">Mark Qualified</button></div>
          </div>
          <div class="grid columns-2" style="max-width:840px;margin-top:10px">
            <label>List by Referrer ID<input id="refListReferrer" type="number" min="1"></label>
            <div class="grid" style="grid-auto-flow:column;align-items:end"><button id="refLoad">Load</button></div>
          </div>
          <div id="refList" class="list" style="margin-top:10px">No referrals.</div>
        </section>
        <section id="vendors" class="section hidden"><h2>Vendors</h2>
          <div class="grid columns-2" style="max-width:860px">
            <div>
              <div id="venList" class="list">Loading...</div>
            </div>
            <form id="venForm" class="grid">
              <h3>Edit Vendor</h3>
              <input type="hidden" name="id" />
              <label>Name<input name="name" required /></label>
              <label>Email<input name="email" /></label>
              <label>Phone<input name="phone" /></label>
              <label>Notes<textarea name="notes" rows="3"></textarea></label>
              <div class="grid" style="grid-auto-flow:column;justify-content:start"><button type="submit">Save</button><button type="button" id="venNew" class="secondary">New</button></div>
              <div id="venMsg" class="muted"></div>
            </form>
          </div>
        </section>
        <section id="support" class="section hidden"><h2>Support</h2>
          <div class="grid" style="max-width:860px">
            <div class="grid" style="grid-auto-flow:column;justify-content:start"><button id="supLoad">Load Tickets</button><button id="supClear" class="secondary">Clear</button></div>
            <div id="supList" class="list">No tickets.</div>
          </div>
        </section>
        <section id="kyc" class="section hidden"><h2>KYC</h2>
          <div class="grid" style="max-width:860px">
            <div class="grid" style="grid-auto-flow:column;justify-content:start">
              <button id="kycLoad">Load Submissions</button>
            </div>
            <div id="kycList" class="list">No submissions.</div>
          </div>
        </section>
      </main>
    </div>
    <button id="globalMenuBtn" title="Menu" aria-label="Menu" style="position:fixed;left:12px;top:12px;z-index:9999;display:none;background:#0f172a;border:1px solid #23304d;color:#e5e7eb;border-radius:10px;padding:10px 12px;cursor:pointer">☰</button>
    <script>
    (async function(){
      async function getRestNonce(){
        const r = await fetch('/wp-admin/admin-ajax.php?action=svntex2_get_rest_nonce', { credentials:'include' });
        try { const j = await r.json(); if(j.success) return j.data.nonce; } catch(e){}
        return null;
      }
      const nonce = await getRestNonce();
      const headers = nonce ? { 'X-WP-Nonce': nonce } : {};
      const res = await fetch('/wp-json/wp/v2/users/me', { credentials: 'include', headers });
      if(!res.ok){
        alert('Your session has expired. Please sign in again.');
        location.href='/admin-v2/';
        return;
      }
      const me = await res.json();
      // Users pre-load (for KPI and quick list)
      const ures = await fetch('/wp-json/wp/v2/users?per_page=10&orderby=registered&order=desc',{ credentials:'include', headers });
      const users = ures.ok ? await ures.json() : [];
      const box = document.getElementById('usersBox');
      box.innerHTML = users.map(u=>`<div>#${u.id} — ${u.name} (${u.email||'-'})</div>`).join('') || 'No users.';

      // Sidebar + menu button
      const layout = document.getElementById('layout');
      const sidebar = document.getElementById('sidebar');
      const btnLocal = document.getElementById('btnToggle');
      const globalBtn = document.getElementById('globalMenuBtn');
      function applyMenuBtn(){ globalBtn.style.display = window.matchMedia('(max-width:900px)').matches ? 'block' : 'none'; }
      applyMenuBtn();
      window.addEventListener('resize', applyMenuBtn);
      function toggleSidebar(){
        if(window.matchMedia('(max-width:900px)').matches){ sidebar.classList.toggle('open'); }
        else { layout.classList.toggle('collapsed'); }
      }
      btnLocal.addEventListener('click', toggleSidebar);
      globalBtn.addEventListener('click', toggleSidebar);

      function toast(t){ let el=document.querySelector('.toast'); if(!el){ el=document.createElement('div'); el.className='toast'; document.body.appendChild(el); } el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2000); }

      // Users management
      const userList = document.getElementById('userList');
      const userForm = document.getElementById('userForm');
      const userMsg = document.getElementById('userMsg');
      function um(t){ userMsg.textContent=t; }
      async function loadUsers(q=''){
        userList.textContent='Loading...';
        const r = await fetch('/wp-json/svntex2/v1/users?per_page=20&search='+encodeURIComponent(q), { credentials:'include', headers });
        const j = await r.json();
        const items = (j && j.items) || [];
        userList.innerHTML = items.map(u=>`<div><a href="#" data-uid="${u.id}">#${u.id}</a> ${u.username} · ${u.email} · ${u.meta.customer_id||''}</div>`).join('') || 'No users.';
      }
      await loadUsers('');
      document.getElementById('userSearch').addEventListener('input', (e)=>{ loadUsers(e.target.value); });
      userList.addEventListener('click', async (e)=>{
        const id = e.target.getAttribute('data-uid'); if(!id) return; e.preventDefault(); um('');
        const r = await fetch('/wp-json/svntex2/v1/users/'+id, { credentials:'include', headers });
        const u = await r.json();
        userForm.id.value = u.id;
        userForm.customer_id.value = u.meta.customer_id || '';
        userForm.email.value = u.email || '';
        userForm.first_name.value = u.first_name || '';
        userForm.last_name.value = u.last_name || '';
        userForm.display_name.value = u.display_name || '';
        userForm.mobile.value = u.meta.mobile || '';
        userForm.gender.value = u.meta.gender || '';
        userForm.dob.value = u.meta.dob || '';
        userForm.employee_id.value = u.meta.employee_id || '';
        userForm.referral_source.value = u.meta.referral_source || '';
      });
      userForm.addEventListener('submit', async (e)=>{
        e.preventDefault(); um('Saving...');
        const data = Object.fromEntries(new FormData(userForm).entries()); const id = data.id; delete data.id; delete data.customer_id;
        const r = await fetch('/wp-json/svntex2/v1/users/'+id, { method:'POST', credentials:'include', headers:{ ...headers, 'Content-Type':'application/json' }, body: JSON.stringify(data) });
        const j = await r.json(); if(j && j.id){ um('Saved'); } else { um(j.error || 'Save failed'); }
      });

      // Products
      const prodList = document.getElementById('prodList');
      const prodForm = document.getElementById('prodForm');
      const prodMsg = document.getElementById('prodMsg');
      function pm(t){ prodMsg.textContent=t; }
      const prodSearch = document.getElementById('prodSearch');
      const prodStatus = document.getElementById('prodStatus');
      const prodStock = document.getElementById('prodStock');
      const prodCatFilter = document.getElementById('prodCatFilter');
      document.getElementById('btnNewProduct')?.addEventListener('click', ()=>{ prodForm.style.display='grid'; window.scrollTo({top: prodForm.offsetTop-60, behavior:'smooth'}); });

      async function loadProducts(){
        pm(''); prodList.textContent = 'Loading...';
        const qs = new URLSearchParams();
        if(prodSearch?.value){ qs.set('search', prodSearch.value.trim()); }
        if(prodStatus?.value){ qs.set('status', prodStatus.value); }
        if(prodStock?.value){ qs.set('stock_status', prodStock.value); }
        if(prodCatFilter?.value){ qs.set('category', prodCatFilter.value); }
        const r = await fetch('/wp-json/svntex2/v1/products'+(qs.toString()?('?'+qs.toString()):''), { credentials:'include', headers });
        const j = await r.json(); const items = (j && j.items) || [];
        prodList.innerHTML = items.map(p=>`<div class="list-item">
          <div style="display:flex;gap:10px;align-items:center">
            ${p.thumbnail_url?`<img src="${p.thumbnail_url}" alt="thumb" style="width:48px;height:48px;object-fit:cover;border-radius:6px">`:''}
            <div><strong>#${p.id}</strong> ${p.title} <div class="meta">SKU ${p.sku||'-'} · ${p.stock_status||'-'} · Qty ${p.stock_qty||0}</div></div>
          </div>
          <div class="grid" style="grid-auto-flow:column;gap:8px;align-items:center">
            <a href="#" data-edit="${p.id}">Edit</a>
            <a href="#" data-del="${p.id}">Delete</a>
            <a href="#" data-toggle-status="${p.id}" data-st="${p.status==='draft'?'publish':'draft'}">${p.status==='draft'?'Make Active':'Make Draft'}</a>
            <a href="#" data-toggle-stock="${p.id}" data-stock="${p.stock_status==='outofstock'?'instock':'outofstock'}">${p.stock_status==='outofstock'?'Mark In-stock':'Mark Out-of-stock'}</a>
          </div>
        </div>`).join('') || '<div class="muted">No products yet.</div>';
      }
      await loadProducts();

      async function loadCategories(){
        const r = await fetch('/wp-json/wp/v2/svntex_category?per_page=100', { credentials:'include', headers });
        const cats = r.ok ? await r.json() : [];
        const sel = document.getElementById('prodCats'); if(sel) sel.innerHTML = cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
        if(prodCatFilter){ prodCatFilter.innerHTML = '<option value="">All</option>' + cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join(''); }
      }
      await loadCategories();

      document.getElementById('prodLoad')?.addEventListener('click', (e)=>{ e.preventDefault(); loadProducts(); });
      prodSearch?.addEventListener('keyup', (e)=>{ if(e.key==='Enter') loadProducts(); });
      prodStatus?.addEventListener('change', ()=> loadProducts());
      prodStock?.addEventListener('change', ()=> loadProducts());
      prodCatFilter?.addEventListener('change', ()=> loadProducts());

      prodList.addEventListener('click', async (e)=>{
        const id = e.target.getAttribute('data-edit');
        if(id){ /* existing edit handler unchanged */ return; }
        const delId = e.target.getAttribute('data-del');
        if(delId){ /* existing delete handler unchanged */ return; }
        const tog = e.target.getAttribute('data-toggle-status');
        const st = e.target.getAttribute('data-st');
        if(tog && st){ e.preventDefault(); const r = await fetch(`/wp-json/svntex2/v1/products/${tog}`, { method:'POST', credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ status: st }) }); const j = await r.json(); toast(j.id?'Updated':'Failed'); loadProducts(); return; }
        const tstock = e.target.getAttribute('data-toggle-stock');
        const nstock = e.target.getAttribute('data-stock');
        if(tstock && nstock){ e.preventDefault(); const r = await fetch(`/wp-json/svntex2/v1/products/${tstock}`, { method:'POST', credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ stock_status: nstock }) }); const j = await r.json(); toast(j.id?'Stock updated':'Failed'); loadProducts(); return; }
      });
      document.getElementById('prodReset').addEventListener('click', (e)=>{ e.preventDefault(); prodForm.reset(); prodForm.id.value=''; document.getElementById('imgPreview').textContent=''; document.getElementById('vidPreview').textContent=''; pm(''); });

  // Product reviews moderation
  document.getElementById('prodRevLoad')?.addEventListener('click', async (e)=>{ e.preventDefault(); const box=document.getElementById('prodReviewsBox'); const pid=box?.getAttribute('data-pid'); if(!pid){ toast('Select a product'); return; } const r=await fetch(`/wp-json/svntex2/v1/products/${pid}/reviews`,{credentials:'include',headers}); const j=await r.json(); const items=j.items||[]; const list=document.getElementById('prodRevList'); list.innerHTML = items.map(rv=>`<div class="list-item"><div>#${rv.id} · ${rv.author||''} · ${rv.status}</div><div class="meta">${rv.date||''}${rv.rating?(' · ★'+rv.rating):''}${rv.featured?' · featured':''}</div><div class="muted" style="margin-top:6px">${(rv.content||'').replace(/[<>]/g,'')}</div><div style="margin-top:6px"><a href="#" data-rid="${rv.id}" data-ra="approve">Approve</a> <a href="#" data-rid="${rv.id}" data-ra="hold">Hold</a> <a href="#" data-rid="${rv.id}" data-ra="trash">Trash</a> <a href="#" data-rid="${rv.id}" data-ra="feature">Feature</a> <a href="#" data-rid="${rv.id}" data-ra="unfeature">Unfeature</a></div></div>`).join('') || '<div class="muted">No reviews.</div>'; });
  document.getElementById('prodRevList')?.addEventListener('click', async (e)=>{ const cid=e.target.getAttribute('data-rid'); const act=e.target.getAttribute('data-ra'); if(!cid||!act) return; e.preventDefault(); const r=await fetch('/wp-json/svntex2/v1/products/0/reviews',{method:'POST',credentials:'include',headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({comment_id:parseInt(cid,10), action:act})}); const j=await r.json(); toast(j.ok?'Done':'Failed'); document.getElementById('prodRevLoad').click(); });

      const imgInput = document.getElementById('prodImage');
      imgInput.addEventListener('change', async (e)=>{
        const file = e.target.files && e.target.files[0]; if(!file){ return; }
        const okTypes = ['image/png','image/jpeg','image/jpg','image/webp'];
        if(!okTypes.includes(file.type)){ toast('Unsupported image type'); e.target.value=''; return; }
        const fd = new FormData(); fd.append('file', file, file.name);
        const r = await fetch('/wp-json/wp/v2/media', { method:'POST', credentials:'include', headers: { ...headers }, body: fd });
        if(!r.ok){ toast('Upload failed'); return; }
        const m = await r.json(); prodForm.featured_media.value = m.id; document.getElementById('imgPreview').innerHTML = `<img src="${m.media_details?.sizes?.thumbnail?.source_url || m.source_url}" style="max-width:120px;border-radius:6px">`;
        toast('Image uploaded');
      });
      const vidInput = document.getElementById('prodVideo');
      vidInput.addEventListener('change', async (e)=>{
        const file = e.target.files && e.target.files[0]; if(!file){ return; }
        const okVideo = ['video/mp4','video/webm','video/ogg'];
        if(!okVideo.includes(file.type)){ toast('Unsupported video type'); e.target.value=''; return; }
        const fd = new FormData(); fd.append('file', file, file.name); fd.append('post', prodForm.id.value || 0);
        const r = await fetch('/wp-json/wp/v2/media', { method:'POST', credentials:'include', headers: { ...headers }, body: fd });
        if(!r.ok){ toast('Video upload failed'); return; }
        const m = await r.json(); prodForm.video_media.value = m.id; document.getElementById('vidPreview').innerHTML = `<video src="${m.source_url}" controls style="max-width:220px;border-radius:6px"></video>`; toast('Video uploaded');
      });
      prodForm.addEventListener('submit', async (e)=>{
        e.preventDefault(); pm('Saving...');
        const data = new FormData(prodForm); const id = data.get('id'); data.delete('id');
        const payload = Object.fromEntries(data.entries());
        if(payload.vendor_id) payload.vendor_id = parseInt(payload.vendor_id,10)||0; else delete payload.vendor_id;
        const catSel = document.getElementById('prodCats'); const selCats = Array.from(catSel.selectedOptions).map(o=>parseInt(o.value,10)).filter(Boolean); payload.categories = selCats.length?selCats:[];
        const brandSel = document.getElementById('brandSelect'); const selBrands = Array.from(brandSel.selectedOptions).map(o=>parseInt(o.value,10)).filter(Boolean); payload.brands = selBrands.length?selBrands:[];
        const tagSel = document.getElementById('tagSelect'); const selTags = Array.from(tagSel.selectedOptions).map(o=>parseInt(o.value,10)).filter(Boolean); payload.tags = selTags.length?selTags:[];
        const scSel = document.getElementById('shipClassSelect'); const sc = parseInt(scSel.value||'0',10)||0; payload.shipping_class = sc ? [sc] : [];
        ['base_price','discount_price','mrp','tax_percent','company_profit','weight','length','width','height'].forEach(k=>{ if(payload[k]!==undefined && payload[k]!=='' ) payload[k] = parseFloat(payload[k]); });
        ['stock_qty','low_stock_threshold'].forEach(k=>{ if(payload[k]!==undefined && payload[k]!=='' ) payload[k] = parseInt(payload[k],10); });
        payload.is_featured = !!data.get('is_featured'); payload.archived = !!data.get('archived'); payload.approved = !!data.get('approved');
        if(galleryIds && galleryIds.length) payload.gallery = galleryIds.slice(); else payload.gallery = [];
        const url = id ? `/wp-json/svntex2/v1/products/${id}` : '/wp-json/svntex2/v1/products';
        const r = await fetch(url, { method:'POST', credentials:'include', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        // Auto-calc Profit
        const pMrp = document.getElementById('pMrp'); const pTax = document.getElementById('pTax'); const pProfit = document.getElementById('pProfit');
        function recalcProfit(){ const mrp = parseFloat(pMrp.value||'0'); const tax = parseFloat(pTax.value||'0'); if(mrp>=0 && tax>=0){ const profit = Math.max(0, mrp - (mrp * (tax/100))); pProfit.value = profit.toFixed(2); } }
        pMrp.addEventListener('input', recalcProfit); pTax.addEventListener('input', recalcProfit);
        const j = await r.json(); if(j.id){ pm('Saved'); toast('Saved'); prodForm.reset(); await loadProducts(); } else { pm(j.error || 'Save failed'); toast('Save failed'); }
      });

      // Logout back to admin-v2 login
      document.getElementById('logout').addEventListener('click', async (e)=>{ e.preventDefault(); try{ await fetch('/wp-admin/admin-post.php?action=svntex2_logout',{credentials:'include'});}catch(e){} const dest=(location.hostname.replace(/^www\./,'')==='svntex.com')?'https://www.svntex.com/admin-v2/':'/admin-v2/'; location.href=dest; });

      // Wallet
      const wUserId = document.getElementById('wUserId');
      const wList = document.getElementById('wList');
      async function loadWallet(){ const q = wUserId.value ? ('?user_id='+encodeURIComponent(wUserId.value)) : ''; const r = await fetch('/wp-json/svntex2/v1/wallet/transactions'+q, { credentials:'include', headers }); const j = await r.json(); const items = j.items || []; wList.innerHTML = items.map(x=>`<div class="list-item"><div>#${x.id} · u${x.user_id} · ${x.type} · ${x.category} · ${x.amount}</div><div class="meta">${x.created_at}</div></div>`).join('') || '<div class="muted">No transactions.</div>'; }
      document.getElementById('wLoad').addEventListener('click', (e)=>{ e.preventDefault(); loadWallet(); });
      // Wallet Adjust quick form UI
      try{
        const wAdj = document.createElement('div'); wAdj.className='grid columns-3'; wAdj.style.maxWidth='840px'; wAdj.style.marginTop='10px';
        wAdj.innerHTML = '<label>Adjust Amount<input id="wAdjAmt" type="number" step="0.01" min="0"></label><label>Direction<select id="wAdjDir"><option value="credit">Credit</option><option value="debit">Debit</option></select></label><div class="grid" style="grid-auto-flow:column;align-items:end"><button id="wAdjBtn">Apply</button></div>';
        const wl = document.getElementById('wList'); wl.parentElement.insertBefore(wAdj, wl);
        document.getElementById('wAdjBtn').addEventListener('click', async (e)=>{ e.preventDefault(); const uid=parseInt(wUserId.value||'0',10)||0; const amt=parseFloat(document.getElementById('wAdjAmt').value||'0')||0; const dir=document.getElementById('wAdjDir').value; if(!uid||!amt){ toast('User and amount required'); return; } const r=await fetch('/wp-json/svntex2/v1/wallet/adjust',{ method:'POST', credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ user_id:uid, amount:amt, direction:dir, category:'general', note:'panel' }) }); const j=await r.json(); toast(j.ok?'Adjusted':'Failed'); loadWallet(); });
      }catch(e){}

      // Referrals
      const refList = document.getElementById('refList');
      async function loadReferrals(){ const v = document.getElementById('refListReferrer').value; const q = v ? ('?referrer_id='+encodeURIComponent(v)) : ''; const r = await fetch('/wp-json/svntex2/v1/referrals'+q, { credentials:'include', headers }); const j = await r.json(); const items = j.items || []; refList.innerHTML = items.map(x=>`<div class="list-item"><div>#${x.id} · ${x.referrer_id} → ${x.referee_id} ${x.qualified? '· qualified':''}</div><div class="meta">${x.created_at||''}</div></div>`).join('') || '<div class="muted">No referrals.</div>'; }
      document.getElementById('refLoad').addEventListener('click', (e)=>{ e.preventDefault(); loadReferrals(); });
      document.getElementById('refLink').addEventListener('click', async (e)=>{ e.preventDefault(); const ref = parseInt(document.getElementById('refReferrer').value,10)||0; const ree = parseInt(document.getElementById('refReferee').value,10)||0; if(!ref||!ree){ toast('IDs required'); return; } const r = await fetch('/wp-json/svntex2/v1/referrals/link', { method:'POST', credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ referrer_id:ref, referee_id:ree }) }); const j = await r.json(); toast(j.ok?'Linked':'Not linked'); loadReferrals(); });
      document.getElementById('refQualify').addEventListener('click', async (e)=>{ e.preventDefault(); const ref = parseInt(document.getElementById('refReferrer').value,10)||0; const ree = parseInt(document.getElementById('refReferee').value,10)||0; const amt = parseFloat(document.getElementById('refAmount').value||'0')||0; if(!ref||!ree){ toast('IDs required'); return; } const r = await fetch('/wp-json/svntex2/v1/referrals/qualify', { method:'POST', credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ referrer_id:ref, referee_id:ree, amount:amt }) }); const j = await r.json(); toast(j.ok?'Qualified':'Failed'); loadReferrals(); });
      
  // Vendors
  const venList = document.getElementById('venList');
  const venForm = document.getElementById('venForm');
  function vm(t){ const el=document.getElementById('venMsg'); if(el) el.textContent=t; }
  async function loadVendorsUI(){ if(!venList) return; venList.textContent='Loading...'; const r=await fetch('/wp-json/svntex2/v1/vendors',{credentials:'include',headers}); const j=await r.json(); const items=j.items||[]; venList.innerHTML = items.map(v=>`<div class="list-item"><div><a href="#" data-vid="${v.id}">#${v.id}</a> ${v.name}</div><div class="meta">${v.email||''} ${v.phone?('· '+v.phone):''}</div></div>`).join('') || '<div class="muted">No vendors.</div>'; }
  if(venList){ await loadVendorsUI(); venList.addEventListener('click', async (e)=>{ const id=e.target.getAttribute('data-vid'); if(!id) return; e.preventDefault(); const r=await fetch('/wp-json/svntex2/v1/vendors/'+id,{credentials:'include',headers}); const v=await r.json(); venForm.id.value=v.id; venForm.name.value=v.name||''; venForm.email.value=v.email||''; venForm.phone.value=v.phone||''; venForm.notes.value=v.notes||''; vm(''); }); }
  document.getElementById('venNew')?.addEventListener('click',(e)=>{ e.preventDefault(); venForm.reset(); venForm.id.value=''; vm(''); });
  venForm?.addEventListener('submit', async (e)=>{ e.preventDefault(); vm('Saving...'); const data=Object.fromEntries(new FormData(venForm).entries()); const id=data.id; delete data.id; const url=id?('/wp-json/svntex2/v1/vendors/'+id):'/wp-json/svntex2/v1/vendors'; const r=await fetch(url,{method:'POST',credentials:'include',headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify(data)}); const j=await r.json(); vm(j.id?'Saved':'Failed'); loadVendorsUI(); });

  // Support Admin
  const supList = document.getElementById('supList');
  document.getElementById('supLoad')?.addEventListener('click', async (e)=>{ e.preventDefault(); const r=await fetch('/wp-json/svntex2/v1/admin/support',{credentials:'include',headers}); const j=await r.json(); const items=j.items||[]; supList.innerHTML = items.map(t=>`<div class="list-item"><div>u${t.user_id} · ${t.subject}</div><div class="meta">${t.ts||''}</div><div class="muted" style="margin-top:6px">${(t.message||'').replace(/[<>]/g,'')}</div></div>`).join('') || '<div class="muted">No tickets.</div>'; });
  document.getElementById('supClear')?.addEventListener('click', async (e)=>{ e.preventDefault(); if(!confirm('Clear all tickets?')) return; const r=await fetch('/wp-json/svntex2/v1/admin/support/clear',{method:'POST',credentials:'include',headers}); const j=await r.json(); if(j.ok){ supList.innerHTML='<div class="muted">No tickets.</div>'; toast('Cleared'); }
  });

      // KYC Admin
      const kycList = document.getElementById('kycList');
      async function loadKyc(){ const r = await fetch('/wp-json/svntex2/v1/kyc', { credentials:'include', headers }); const j = await r.json(); const items = j.items || []; kycList.innerHTML = items.map(x=>`<div class="list-item"><div>User ${x.user_id} · ${x.status}</div><div><a href="#" data-kyc-user="${x.user_id}" data-kyc-status="approved">Approve</a> <a href="#" data-kyc-user="${x.user_id}" data-kyc-status="rejected">Reject</a></div></div>`).join('') || '<div class="muted">No submissions.</div>'; }
      document.getElementById('kycLoad').addEventListener('click', (e)=>{ e.preventDefault(); loadKyc(); });
      kycList.addEventListener('click', async (e)=>{ const uid = e.target.getAttribute('data-kyc-user'); const st = e.target.getAttribute('data-kyc-status'); if(!uid||!st) return; e.preventDefault(); const r = await fetch(`/wp-json/svntex2/v1/kyc/${uid}`, { method:'POST', credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ status:st }) }); const j = await r.json(); if(j && j.user_id){ toast('KYC '+st); loadKyc(); } else { toast('Failed'); } });

  // Orders Admin
  const ordList = document.getElementById('ordList');
  const ordLoadBtn = document.getElementById('ordLoad'); if(ordLoadBtn){ ordLoadBtn.addEventListener('click', async (e)=>{ e.preventDefault(); await loadOrdersAdmin(); }); }
  async function loadOrdersAdmin(){ const st = document.getElementById('ordStatus').value; const q = st? ('?status='+encodeURIComponent(st)) : ''; const r = await fetch('/wp-json/svntex2/v1/admin/orders'+q, { credentials:'include', headers }); const j = await r.json(); const items=j.items||[]; ordList.innerHTML = items.map(o=>`<div class="list-item"><div>#${o.id} · u${o.user_id} · ${o.status}</div><div class="meta">₹${Number(o.grand_total||0).toFixed(2)} · ${o.created_at}</div><div><a href="#" data-oid="${o.id}" data-st="processing">Processing</a> <a href="#" data-oid="${o.id}" data-st="shipped">Shipped</a> <a href="#" data-oid="${o.id}" data-st="delivered">Delivered</a></div></div>`).join('') || '<div class="muted">No orders.</div>'; }
  if(ordList){ ordList.addEventListener('click', async (e)=>{ const id=e.target.getAttribute('data-oid'); const st=e.target.getAttribute('data-st'); if(!id||!st) return; e.preventDefault(); const r=await fetch('/wp-json/svntex2/v1/admin/orders/'+id,{ method:'POST', credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ status:st }) }); const j=await r.json(); toast(j.id?'Updated':'Failed'); loadOrdersAdmin(); }); }

  // Withdrawals Admin
  const wdAdminList = document.getElementById('wdAdminList');
  const wdAdminLoad = document.getElementById('wdAdminLoad'); if(wdAdminLoad){ wdAdminLoad.addEventListener('click', async (e)=>{ e.preventDefault(); await loadWdAdmin(); }); }
  async function loadWdAdmin(){ const st=document.getElementById('wdStatus').value; const q=st?('?status='+encodeURIComponent(st)) : ''; const r=await fetch('/wp-json/svntex2/v1/admin/withdrawals'+q,{ credentials:'include', headers }); const j=await r.json(); const items=j.items||[]; wdAdminList.innerHTML = items.map(w=>`<div class="list-item"><div>#${w.id} · u${w.user_id} · ${w.status}</div><div class="meta">₹${Number(w.amount||0).toFixed(2)}${w.net_amount?(' · Net ₹'+Number(w.net_amount).toFixed(2)) : ''} · ${w.requested_at||''}</div><div>${w.status==='requested'?`<a href="#" data-wid="${w.id}" data-act="approve">Approve</a> <a href="#" data-wid="${w.id}" data-act="reject">Reject</a>`:''}</div></div>`).join('') || '<div class="muted">No withdrawals.</div>'; }
  if(wdAdminList){ wdAdminList.addEventListener('click', async (e)=>{ const id=e.target.getAttribute('data-wid'); const act=e.target.getAttribute('data-act'); if(!id||!act) return; e.preventDefault(); const note=prompt('Note (optional)',''); const r=await fetch('/wp-json/svntex2/v1/admin/withdrawals/'+id,{ method:'POST', credentials:'include', headers:{...headers,'Content-Type':'application/json'}, body: JSON.stringify({ action:act, admin_note: note||'' }) }); const j=await r.json(); toast(j.ok?'Updated':'Failed'); loadWdAdmin(); }); }
    })();
    </script>
  </body>
</html>
